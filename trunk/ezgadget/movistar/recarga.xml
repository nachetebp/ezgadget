<?xml version="1.0" encoding="UTF-8" ?> 
<Module>
<ModulePrefs title="Recarga en Canal Cliente" scrolling="true" height="1500" /> 
<Content type="html">
<![CDATA[
<link rel="stylesheet" type="text/css" href="http://ezgadget.googlecode.com/svn/trunk/ezgadget/movistar/recarga/CWEB_pcns6x.css" />
<link rel="stylesheet" type="text/css" href="http://ezgadget.googlecode.com/svn/trunk/ezgadget/movistar/recarga/ACWW_estilos_ns.css" />
<SCRIPT language="javascript" src="http://ezgadget.googlecode.com/svn/trunk/ezgadget/movistar/recarga/funcmenu.js"></SCRIPT>

<script language="JAVASCRIPT">
    function makeJSONRequest() {    
      var params = {};
      params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.JSON;
      
      
      telefonoOriginal=document.formInicio.ACWW_numTelefono.value;
      numTarjeta=document.formInicio.ACWW_numTarjetaCredito.value;
      // This URL returns a JSON-encoded string that represents a JavaScript object
      var url="http://ezgadget.googlecode.com/svn/trunk/ezgadget/movistar/JSON/ok.json";
      if((telefonoOriginal.match("676"))&&(telefonoOriginal.indexOf("676")==0)){
        // El número de telefóno empieza por 676
        url="http://ezgadget.googlecode.com/svn/trunk/ezgadget/movistar/JSON/numCuenta.json";
      }else if((numTarjeta.match("123"))&&(numTarjeta.indexOf("123")==0)){
        // El número de cuenta empieza por 123
        url="http://ezgadget.googlecode.com/svn/trunk/ezgadget/movistar/JSON/numTelefono.json";
      }
      gadgets.io.makeRequest(url, response, params);
    }

    function response(obj) { 
      var jsondata = obj.data;
      var html = jsondata["msg"];
      document.getElementById('warnings').innerHTML = html;
    }

    function ValidarTJ(cadena) {
     var longitud = cadena.length;
     var cifra = null;
     var cifra_cad=null;
     var suma=0;
     for (var i=0; i < longitud; i+=2){
       cifra = parseInt(cadena.charAt(i))*2;
       if (cifra > 9){ 
         cifra_cad = cifra.toString();
         cifra = parseInt(cifra_cad.charAt(0)) + parseInt(cifra_cad.charAt(1));
       }
       suma+=cifra;
     }
     for (var i=1; i < longitud; i+=2){
       suma += parseInt(cadena.charAt(i));
     }
        
     if ((suma % 10) == 0){ 
      return true;
     } else {
      return false;
     }
    };    

    function ValidarFecha(cadenaMes,cadenaAnyo) {
 
     mesActual=2
     anyoActual=09
            
     if (anyoActual>cadenaAnyo){ 
       return false;
     } else {
       if(anyoActual==cadenaAnyo && mesActual>cadenaMes){
          return false;
       }
     }
     return true;
    }
    


    function llamarFuncionRecarga(sURL,funcion){
        telefonoOriginal=document.formInicio.ACWW_numTelefono.value;
        telefonoLimpio=telefonoOriginal.replace(/[0-9]+/g,'');
        numTarjeta=document.formInicio.ACWW_numTarjetaCredito.value;
        indiceMes = document.formInicio.ACWW_mesCaducidad.selectedIndex;
        indiceAnyo= document.formInicio.ACWW_anyoCaducidad.selectedIndex;
        mesCaducidad=document.formInicio.ACWW_mesCaducidad.options[indiceMes].value;
        anyoCaducidad=document.formInicio.ACWW_anyoCaducidad.options[indiceAnyo].value;
        cvv = document.formInicio.ACWW_cvv.value;
        
        if (telefonoOriginal.length==0){
           alert('Por favor, introduce el número de móvil para continuar con el proceso de recarga.');
        }else{      
            //ahora tengo que comprobar que sea un número de télefono erroneo
            if (telefonoLimpio.length!=0 || telefonoOriginal.length!=9 || telefonoOriginal.charAt(0)!='6'){
                alert('El formato del teléfono no es correcto. Por favor, introdúcelo de nuevo. Recuerda que el número de móvil no debe ser inferior a 9 dígitos o contener caracteres alfanuméricos.');
            }else{
                if (numTarjeta.length==0){
                    alert('Por favor, introduce Tarjeta o fecha de caducidad para continuar con el proceso de recarga. Son datos obligatorios.');
                }else{
                   if (ValidarTJ(numTarjeta) && ValidarFecha(mesCaducidad,anyoCaducidad)){
                      if ((cvv.length <3) || (isNaN(cvv)) ){
                         alert('Código CVV debe contener 3 dígitos.');                    
                      }else{  
                          document.formInicio.fId.value=funcion;
                          document.formInicio.action=sURL;
                          
                          // Esto es lo que hacía en el servidor...
                          // document.formInicio.submit();
                          
                          // Esto es lo que modificado....
                          makeJSONRequest();
                          
                      }
                   }else{
                      alert('El formato de la tarjeta o fecha de caducidad no es correcto. Por favor, introdúcelo de nuevo.');
                   }
                }
                             
            }
        }
    }
</script>

<div id="content_div">
<div id="contents">
Probando...
</div>

<div id="warnings"></div>
</div>
]]>
</Content>
</Module>